
## Lua Profiler For Unity

### Support Status
Currently, it only supports Unity editors version 5.6 or higher on Windows, and is compatible with all versions of Lua in the market, including various custom modifications.

![](doc/use.gif)
### Deployment and Installation
Simply copy the LuaProfiler folder from the example directory to your project directory.

### Usage Instructions
Under the Windows menu, there is a LuaProfiler option. Click it to open the profiler window. Enable DeepLua, run the game, and you will be able to see the relevant data.

### Data Description

|Name|Descriptions|
|---|---|
|`Overview`|Function name|
|`totalLuaMemory`|The sum of all Lua GCs generated by this function|
|`self`|The GC amount generated by the function itself|
|`totalMonoMemory`|The sum of all Mono GCs generated by this function|
|`self`|The GC amount generated by the function itself|
|`currentTime`|The time required for the function to run in the current frame|
|`averageTime`|The average time spent on the function|
|`totalTime`|The total time consumed by this function|
|`LuaGC`|Lua GC generated in the current frame|
|`MonoGC`|Mono GC generated in the current frame|
|`totalCalls`|The number of times this function has run since the start of the game|
|`Calls`|The number of executions of the function in the current frame|

### FAQ

Regarding the issue that the XLua demo won't run
> Move the assignment of `internal static LuaEnv luaEnv = new LuaEnv()` in LuaBehaviour from the Demo to the `Awake` method.

About Custom Profiler Points
```
local LuaProfiler = require('MikuLuaProfiler').LuaProfiler
LuaProfiler.BeginSampleCustom("profiler name")
-- your code
LuaProfiler.EndSampleCustom()
```

When totalLuaMemory is negative after running
> The underlying Lua memory allocation statistics use the total amount of the Lua virtual machine to record the corresponding GC. If a GC occurs during the function's execution, it will result in a negative memory difference. You can disable automatic GC to get accurate statistics.

How to Sort Lua Function Data
> Enter [lua] in the search box, then click the merge button in the upper right corner, and finally click on the various data labels to sort.
![](doc/sort.png)

How to Locate Points of Lua Memory Surge
> Start the game in **Record** mode, click **StartRecord** at the point where you want to sample. After capturing the record, find a section where the memory clearly increases, sample it, and analyze the function. (Click with the mouse, then use the left and right keys on the keyboard)
![](doc/record.png)

What does the `ref` function represent?
> This usually stores callback functions held by C#. You can clear the data before opening the UI each time, then record data after entering the UI. If many delegates are still held after releasing the UI, it indicates a leak.

What are the uses of MarkStaticRecord, MarkLuaRecord, DiffRecord, and ClearDiff?
> This set of features is used for leak detection. For example, you can MarkStaticRecord before opening a UI to take a memory snapshot, then MarkLuaRecord after opening the UI for a second snapshot, and finally DiffRecord at the point where you call the UI's release function. If an object is not held before opening the UI but is held after both opening and releasing the UI, it indicates a leak. The function APIs are:
```
function miku_do_record(val, prefix, key, record, history, null_list, staticRecord)

function miku_diff(record, staticRecord)
```
What are the uses of DeepMono, Discard Invalid, and Precompile Lua options?
> DeepMono: If most of your code is in Assembly-CSharp.dll, you can enable DeepMono to display all mutual calls between C# and Lua. Discard Invalid: Due to the high pressure of recording, some functions with no memory consumption and low time cost are excluded. Precompile Lua: If you're having trouble running this toolset, you can use LuaInject.exe in Tools to process your Lua code. It's simple to use: copy it to your Lua folder, run it with a double-click, and the necessary code will be inserted.

We have temporarily given up on real-device debugging. If you want to debug on a real device, you can try the master version. There are no significant issues with the xlua project.

<span id="contact_zh"></span>
### [Contact](#zh)
If you find any errors or have any suggestions, join the QQ group: [882425563](https://jq.qq.com/?_wv=1027&k=5QkOBSc) to contact us.

<span id="contact_zh"></span>
## Donations
![](doc/zfb.png)

## 
![](doc/meizi.gif)
